# TCO-анализ: сравнение архитектур хранения данных «Будущее 2.0»

## Исходные данные для расчёта

| Параметр | Значение |
|----------|----------|
| Текущий объём данных | 300 Тб (с резервированием — 600 Тб) |
| Прогнозируемый объём через 3 года | 1 Пб (с резервированием — 2 Пб) |
| Средний рост данных в год | ~233 Тб/год |
| Тип данных | Преимущественно неструктурированные (медицинские снимки, документы) |

## Почему выгодно заменить MS SQL Server на LakeHouse

### Проблемы текущей архитектуры

1. **Стоимость лицензий MS SQL Server Enterprise**
   - $15,123 за 2-core pack ([официальные цены Microsoft](https://www.microsoft.com/en-us/sql-server/sql-server-2022-pricing))
   - Для кластера на 600 Тб нужно минимум 64+ ядер = **~$484,000** только на лицензии
   - При масштабировании до 2 Пб — пропорциональный рост

2. **Антипаттерны использования**
   - MS SQL Server используется для хранения неструктурированных данных (снимки, документы) — неэффективно
   - Отсутствуют аналитические витрины — каждый отчёт работает с сырыми данными
   - Производительность деградирует при росте объёмов

3. **Ограничения масштабирования**
   - Enterprise требуется для кэша данных >128 ГБ
   - Вертикальное масштабирование упирается в физические лимиты серверов

### Преимущества LakeHouse (MinIO + Iceberg + Spark)

1. **Нулевые лицензионные затраты** — весь стек open-source
2. **Горизонтальное масштабирование** — добавляем узлы по мере роста
3. **Разделение хранения и вычислений** — оптимизация затрат
4. **Эффективность хранения** — колоночный формат Parquet/ORC сжимает данные в 3-10 раз
5. **ACID-транзакции** — Iceberg обеспечивает консистентность

---

## Сравнение TCO на горизонте 3 года

### Сценарий 1: On-Premise MS SQL Server DWH

#### Архитектура: 4 Compute-сервера + 10 Storage-серверов (SAN)

SQL Server — не распределённая система. Для петабайтного DWH используется архитектура с отдельным хранилищем:
- **4 мощных compute-сервера** (SQL Server с AlwaysOn AG)
- **10 storage-серверов** (SAN-массив, 2.6 ПБ сырой ёмкости)

#### Compute-серверы SQL Server (4 шт) — 3,961,716 ₽/шт

| Компонент | Спецификация | Кол-во | Цена за ед. | Итого |
|-----------|--------------|--------|-------------|-------|
| CPU | [Intel Xeon Platinum 8480+ (56C)](https://digital-tex.ru/catalog/komplektuyushchie/komplektuyushchie_dlya_serverov/protsessory/protsessor_intel_xeon_platinum_8480_pk8071305074801srm7h/) × 2 | 8 | 898,098 ₽ | 7,184,784 ₽ |
| RAM | DDR5 128GB ECC Samsung × 8 = 1TB/узел | 32 | 115,000 ₽ | 3,680,000 ₽ |
| NVMe TempDB | [Samsung PM9A3 7.68TB](https://secumarket.ru/product/pm9a3-7-68tb-mzql27t6hbla-00a07-122584) × 4 | 16 | 134,880 ₽ | 2,158,080 ₽ |
| Сеть 100GbE | [Mellanox ConnectX-6 Dx](https://3logic.ru/products/mcx623106ac-cdat-connectx-6-dx-en-adapter-card-100gbe-dual-port-qsfp56-pcie-4-0-x16-crypto-and--90098/) | 4 | 106,000 ₽ | 424,000 ₽ |
| Платформа 2U | Dual Socket Server | 4 | 600,000 ₽ | 2,400,000 ₽ |
| **Итого Compute** | | | | **15,846,864 ₽** |

#### Storage-серверы SAN (10 шт) — 1,320,000 ₽/шт

| Компонент | Спецификация | Кол-во | Цена за ед. | Итого |
|-----------|--------------|--------|-------------|-------|
| HDD | [WD/Seagate 22TB SATA](https://www.regard.ru/reciept/30948123/servernye-zestkie-diski-hdd-22-tb) × 12 | 120 | 47,000 ₽ | 5,640,000 ₽ |
| RAID-контроллер | Enterprise HBA/RAID | 10 | 150,000 ₽ | 1,500,000 ₽ |
| Сеть 100GbE | [Mellanox ConnectX-6 Dx](https://3logic.ru/products/mcx623106ac-cdat-connectx-6-dx-en-adapter-card-100gbe-dual-port-qsfp56-pcie-4-0-x16-crypto-and--90098/) | 10 | 106,000 ₽ | 1,060,000 ₽ |
| Платформа 2U 12LFF | Storage Server | 10 | 500,000 ₽ | 5,000,000 ₽ |
| **Итого Storage** | | | | **13,200,000 ₽** |

#### Сетевая инфраструктура и стойки

| Компонент | Стоимость |
|-----------|-----------|
| Коммутаторы 100GbE (Spine-Leaf) | ~6,000,000 ₽ |
| Кабели, оптика, DAC | ~2,500,000 ₽ |
| Серверные стойки + ИБП | ~1,500,000 ₽ |
| **Итого инфраструктура** | **~10,000,000 ₽** |

#### **Итого оборудование: ~39,064,000 ₽**

#### Лицензии MS SQL Server Enterprise

| Статья | Расчёт | Стоимость |
|--------|--------|-----------|
| Ядра | 4 сервера × 2 CPU × 56 cores = **448 ядер** | — |
| 2-core packs | 224 шт × $15,123 = $3,387,552 | — |
| Курс USD/RUB | ×100 ₽ | **~338,755,200 ₽** |
| Software Assurance (3 года) | 25% в год × 3 | **~254,066,400 ₽** |
| **Итого лицензии** | | **~592,821,600 ₽** |

*Примечание: лицензии составляют **93.8%** от общей стоимости решения.*

#### Персонал

| Роль | Кол-во | Зарплата gross/мес | С налогами (×1.43) | За 3 года |
|------|--------|-------------------|-------------------|-----------|
| DBA MS SQL | 3 | 250,000 ₽ | 357,500 ₽ | 38,610,000 ₽ |
| Системный администратор | 2 | 200,000 ₽ | 286,000 ₽ | 20,592,000 ₽ |
| **Итого персонал** | | | | **59,202,000 ₽** |

#### Прочие расходы

| Статья | Стоимость за 3 года |
|--------|---------------------|
| Электроэнергия (~30 кВт × 24 × 365 × 3 × 8 ₽/кВтч) | ~6,300,000 ₽ |
| Охлаждение и ЦОД | ~4,000,000 ₽ |
| Поддержка оборудования (5% в год) | ~5,900,000 ₽ |
| **Итого прочее** | **~16,200,000 ₽** |

#### **ИТОГО TCO On-Premise MS SQL Server: ~707,288,000 ₽ (~$7,073,000)**

---

### Сценарий 2: Облачный MS SQL Server (Yandex Cloud)

#### Вычислительные ресурсы Yandex Managed Service for SQL Server

| Ресурс | Конфигурация | Цена/мес | За 3 года |
|--------|--------------|----------|-----------|
| Кластер SQL Server | s3-c96-m576 × 4 узла | ~1,200,000 ₽ | 43,200,000 ₽ |
| Хранилище SSD | 2 Пб (растущее) в среднем 1.3 Пб | ~2,600,000 ₽ | 93,600,000 ₽ |
| Резервное копирование | ~200 Тб | ~100,000 ₽ | 3,600,000 ₽ |
| Сеть (egress) | ~100 Тб/мес | ~500,000 ₽ | 18,000,000 ₽ |
| **Итого облако** | | | **158,400,000 ₽** |

#### Лицензии MS SQL Server Enterprise

| Статья | Расчёт | Стоимость |
|--------|--------|-----------|
| Ядра | 4 узла × 96 vCPU = **384 ядра** | — |
| 2-core packs | 192 шт × $15,123 = $2,903,616 | — |
| Курс USD/RUB | ×100 ₽ | **~290,361,600 ₽** |
| Software Assurance (3 года) | 25% в год × 3 | **~217,771,200 ₽** |
| **Итого лицензии** | | **~508,132,800 ₽** |

*Примечание: Yandex Cloud требует BYOL (Bring Your Own License) для MS SQL Server.*

#### Персонал

| Роль | Кол-во | Зарплата gross/мес | С налогами (×1.43) | За 3 года |
|------|--------|-------------------|-------------------|-----------|
| DBA MS SQL | 3 | 250,000 ₽ | 357,500 ₽ | 38,610,000 ₽ |
| Cloud-инженер | 1 | 220,000 ₽ | 314,600 ₽ | 11,325,600 ₽ |
| **Итого персонал** | | | | **49,935,600 ₽** |

#### **ИТОГО TCO Облачный MS SQL Server: ~716,468,400 ₽ (~$7,165,000)**

---

### Сценарий 3: On-Premise LakeHouse (MinIO + Spark + Iceberg)

#### Конфигурация Storage-кластера (MinIO) — 8 узлов

**Профиль: High Density Storage** — плотность дисков и пропускная способность сети, CPU вторичен.

| Компонент | Спецификация | Кол-во | Цена за ед. | Итого |
|-----------|--------------|--------|-------------|-------|
| Платформа | [Supermicro 6029U-E1CR4T 2U 12LFF](https://serverflow.ru/config/servernaya-platforma-supermicro-superserver-6029u-e1cr4t-2u-12lff-4x-u-2-2x-750w-2x-lga3647/) | 8 | ~400,000 ₽ | 3,200,000 ₽ |
| CPU | Intel Xeon Silver (24C) — входит в базу | 8 | — | — |
| RAM | DDR4 ECC 64GB × 2 = 128GB/узел | 16 | ~15,000 ₽ | 240,000 ₽ |
| HDD Data | [WD Gold 22TB (WD221KRYZ)](https://www.ozon.ru/product/western-digital-22-tb-vnutrenniy-zhestkiy-disk-wd221kryz-924960530/) | 96 (12/узел) | ~55,000 ₽ | 5,280,000 ₽ |
| NVMe Cache | [Micron 7450 PRO 3.84TB U.2](https://shop.nav-it.ru/catalogue/servernye_zhestkie_diski_ssd/micron_7450_pro_3_84tb_nvme_u_3_15mm_ssd_enterprise_solid_state_drive_1_year_oem/) | 16 (2/узел) | ~60,000 ₽ | 960,000 ₽ |
| Сеть 100GbE | [Mellanox ConnectX-6 Dx 100GbE](https://wit.ru/parts/mcx623106ac-cdat-mellanox-connectx-6-dx-en-adapter-card-100gbe-dual-port-qsfp56-pcie-4.0-x16-crypto-and-secure-boot-tall-bracket-1112812) | 8 | ~100,000 ₽ | 800,000 ₽ |
| **Итого Storage** | 8 узлов × ~1.25 млн ₽ | | | **~10,480,000 ₽** |

*Сырая ёмкость: 8 × 12 × 22 ТБ = 2.1 ПБ. С Erasure Coding 4+4 полезная ёмкость ~1 ПБ.*

#### Конфигурация Compute-кластера (Spark) — 10 узлов

**Профиль: Memory Optimized** — много ядер, 1 ТБ RAM на узел, быстрый NVMe для Shuffle.

| Компонент | Спецификация | Кол-во | Цена за ед. | Итого |
|-----------|--------------|--------|-------------|-------|
| Платформа | [Supermicro AS-2024US-TRT 2U](https://serverflow.ru/catalog/servery/server-supermicro-as-2024us-trt-2u-12lf/) | 10 | ~500,000 ₽ | 5,000,000 ₽ |
| CPU | [Intel Xeon Gold 6430 32C](https://www.regard.ru/product/425975/servernyi-processor-intel-xeon-gold-6430-oem) × 2 | 20 | ~150,000 ₽ | 3,000,000 ₽ |
| RAM | [Samsung 64GB DDR5 ECC REG](https://www.regard.ru/product/741968/operativnaia-pamiat-64gb-ddr5-6400mhz-samsung-ecc-rdimm-m321r8ga0pb2-ccp-oem) × 16 = 1TB/узел | 160 | ~25,000 ₽ | 4,000,000 ₽ |
| NVMe Shuffle | [Micron 7450 PRO 3.84TB](https://shop.nav-it.ru/catalogue/servernye_zhestkie_diski_ssd/micron_7450_pro_3_84tb_nvme_u_3_15mm_ssd_enterprise_solid_state_drive_1_year_oem/) × 2 | 20 | ~60,000 ₽ | 1,200,000 ₽ |
| Сеть 25GbE | [Mellanox ConnectX-6 Lx 25GbE](https://market.yandex.ru/card/setevoy-adapter-mellanox-connectx-6-lx-en-adapter-card-25gbe-dual-port-sfp28-pcie-40-x8-no-crypto-tall-bracket-1-year/4300319168) | 10 | ~40,000 ₽ | 400,000 ₽ |
| **Итого Compute** | 10 узлов × ~1.36 млн ₽ | | | **~13,600,000 ₽** |

*Суммарно: 640+ ядер CPU, 10 ТБ RAM — достаточно для обработки 5 ТБ данных в памяти.*

#### Сетевое ядро (Network Backbone)

| Компонент | Спецификация | Кол-во | Цена за ед. | Итого |
|-----------|--------------|--------|-------------|-------|
| Коммутатор 100GbE | [Eltex MES5500-32](https://www.layta.ru/elteks-mes5500-32.html) (32 порта, российский реестр) | 2 | ~1,500,000 ₽ | 3,000,000 ₽ |
| Кабели DAC/Optics | 100G QSFP28 DAC, 25G SFP28 DAC | — | — | ~500,000 ₽ |
| **Итого сеть** | | | | **~3,500,000 ₽** |

#### Стойка и инфраструктура

| Компонент | Стоимость |
|-----------|-----------|
| Серверная стойка 42U + PDU | ~300,000 ₽ |
| ИБП 20 кВА | ~700,000 ₽ |
| Прочее (кабели, KVM) | ~500,000 ₽ |
| **Итого инфраструктура** | **~1,500,000 ₽** |

#### Лицензии

| Компонент | Стоимость |
|-----------|-----------|
| MinIO, Spark, Iceberg, Kafka, Airflow, etc. | **0 ₽** (open-source, GNU AGPL / Apache 2.0) |

#### **Итого оборудование: ~29,080,000 ₽ (~$290,000)**

#### Персонал

| Роль | Кол-во | Зарплата gross/мес | С налогами (×1.43) | За 3 года |
|------|--------|-------------------|-------------------|-----------|
| Data Engineer | 3 | 280,000 ₽ | 400,400 ₽ | 43,243,200 ₽ |
| DevOps/SRE | 2 | 250,000 ₽ | 357,500 ₽ | 25,740,000 ₽ |
| Системный администратор | 1 | 200,000 ₽ | 286,000 ₽ | 10,296,000 ₽ |
| **Итого персонал** | | | | **79,279,200 ₽** |

#### Прочие расходы

| Статья | Стоимость за 3 года |
|--------|---------------------|
| Электроэнергия (~20 кВт × 24 × 365 × 3 × 8 ₽/кВтч) | ~4,200,000 ₽ |
| Охлаждение и ЦОД (colocation или собственное) | ~3,000,000 ₽ |
| Поддержка оборудования (5% в год) | ~4,400,000 ₽ |
| **Итого прочее** | **~11,600,000 ₽** |

#### **ИТОГО TCO On-Premise LakeHouse: ~138,534,200 ₽ (~$1,385,000)**

---

### Сценарий 4: Облачный LakeHouse (Yandex Cloud)

#### Вычислительные ресурсы

| Сервис | Конфигурация | Цена/мес | За 3 года |
|--------|--------------|----------|-----------|
| **Object Storage (S3)** | 2 Пб (в среднем 1.3 Пб) | ~650,000 ₽ | 23,400,000 ₽ |
| **Data Proc (Spark)** | s3-c64-m256 × 6 узлов (по запросу, ~40% времени) | ~480,000 ₽ | 17,280,000 ₽ |
| **Managed ClickHouse** | s3-c16-m64 × 3 узла | ~150,000 ₽ | 5,400,000 ₽ |
| **Managed Kafka** | s3-c8-m32 × 3 узла | ~90,000 ₽ | 3,240,000 ₽ |
| **Managed Kubernetes** | 10 узлов s3-c8-m32 | ~200,000 ₽ | 7,200,000 ₽ |
| **Сеть (egress)** | ~50 Тб/мес | ~250,000 ₽ | 9,000,000 ₽ |
| **Резервное копирование** | | ~50,000 ₽ | 1,800,000 ₽ |
| **Итого облако** | | | **67,320,000 ₽** |

#### Персонал

| Роль | Кол-во | Зарплата gross/мес | С налогами (×1.43) | За 3 года |
|------|--------|-------------------|-------------------|-----------|
| Data Engineer | 3 | 280,000 ₽ | 400,400 ₽ | 43,243,200 ₽ |
| Cloud-инженер | 1 | 250,000 ₽ | 357,500 ₽ | 12,870,000 ₽ |
| **Итого персонал** | | | | **56,113,200 ₽** |

#### **ИТОГО TCO Облачный LakeHouse: ~123,433,200 ₽ (~$1,234,000)**

---

## Затраты на миграцию (единовременные)

При переходе на LakeHouse необходимо учесть дополнительные затраты:

### Доработка систем

| Статья | Трудозатраты | Стоимость |
|--------|--------------|-----------|
| **Доработка BI-систем** (Power BI → Trino/ClickHouse) | 3 разработчика × 3 мес | 3,600,000 ₽ |
| **Доработка ИИ-сервисов** (миграция загрузки снимков) | 2 разработчика × 2 мес | 1,600,000 ₽ |
| **ETL-миграция** (перенос процессов в Airflow/Spark) | 4 разработчика × 4 мес | 6,400,000 ₽ |
| **Интеграционное тестирование** | 2 QA × 2 мес | 1,200,000 ₽ |
| **Итого доработка** | | **12,800,000 ₽** |

*Расчёт: средняя зарплата разработчика 250,000 ₽ gross × 1.43 (налоги) × кол-во × месяцы*

### Обучение персонала

| Статья | Расчёт | Стоимость |
|--------|--------|-----------|
| Обучение Spark/Iceberg | 20 чел × 5 дней × 15,000 ₽/день | 1,500,000 ₽ |
| Обучение Kafka/EDA | 15 чел × 3 дня × 15,000 ₽/день | 675,000 ₽ |
| Обучение DataHub/Trino | 30 чел × 2 дня × 10,000 ₽/день | 600,000 ₽ |
| Потеря производительности (2 мес) | ~10% от ФОТ команды | 3,000,000 ₽ |
| **Итого обучение** | | **5,775,000 ₽** |

### **ИТОГО затраты на миграцию: ~18,575,000 ₽**

---

## Сводная таблица TCO (3 года)

| Сценарий | Железо/Облако | Лицензии | Персонал | Прочее | Миграция | **ИТОГО** |
|----------|---------------|----------|----------|--------|----------|-----------|
| **On-Premise MS SQL** | 39.1 млн ₽ | 592.8 млн ₽ | 59.2 млн ₽ | 16.2 млн ₽ | — | **707.3 млн ₽** |
| **Облако MS SQL** | 158.4 млн ₽ | 508.1 млн ₽ | 49.9 млн ₽ | — | — | **716.5 млн ₽** |
| **On-Premise LakeHouse** | 29.1 млн ₽ | 0 ₽ | 79.3 млн ₽ | 11.6 млн ₽ | 18.6 млн ₽ | **138.6 млн ₽** |
| **Облако LakeHouse** | 67.3 млн ₽ | 0 ₽ | 56.1 млн ₽ | — | 18.6 млн ₽ | **142.0 млн ₽** |

## Визуализация сравнения

```
TCO за 3 года (млн ₽)
                                                                                          
On-Premise MS SQL    ██████████████████████████████████████████████████████████████████████  707.3
Облако MS SQL        ███████████████████████████████████████████████████████████████████████ 716.5
On-Premise LakeHouse ██████████████                                                          138.6
Облако LakeHouse     ██████████████                                                          142.0
                     ─────────────────────────────────────────────────────────────────────────────
                     0       100     200     300     400     500     600     700     800
```

## Выводы

1. **LakeHouse в 5 раз дешевле MS SQL** — On-Premise LakeHouse (~138.6 млн ₽) экономит 568.7 млн ₽ (80%) по сравнению с On-Premise MS SQL (~707.3 млн ₽).

2. **Лицензии MS SQL — 84% бюджета**. Именно стоимость лицензий делает SQL Server неконкурентоспособным для петабайтных хранилищ.

3. **On-Premise vs Облако LakeHouse** практически равны по стоимости (~3.4 млн ₽ разница). Выбор зависит от требований к локализации и модели CAPEX/OPEX.

4. **Основная экономия** достигается за счёт:
   - Нулевых лицензионных затрат (open-source стек)
   - Эффективного хранения неструктурированных данных в S3 (HDD вместо SSD)
   - Разделения хранения и вычислений (Storage-Compute Separation)

5. **Рекомендация**: **LakeHouse (On-Premise или Облако)** — единственный экономически обоснованный вариант для петабайтного DWH.

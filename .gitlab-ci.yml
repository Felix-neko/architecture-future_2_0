# =============================================================================
# GitLab CI/CD Pipeline
#
# –≠—Ç–æ—Ç –ø–∞–π–ø–ª–∞–π–Ω –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º push –≤ –≤–µ—Ç–∫—É terraform
# –∏ –∑–∞—Ç–µ–º –¥–µ–ª–∞–µ—Ç push –≤ –æ—Å–Ω–æ–≤–Ω–æ–π GitHub-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
# =============================================================================

# –°—Ç–∞–¥–∏–∏ –ø–∞–π–ø–ª–∞–π–Ω–∞
stages:
  - test           # –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
  - build          # –°–±–æ—Ä–∫–∞ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
  - deploy         # –î–µ–ø–ª–æ–π / push –≤ GitHub

# –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
variables:
  # –í–µ—Ç–∫–∞ –¥–ª—è push –≤ GitHub
  GITHUB_BRANCH: main
  # URL GitHub-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è (–±–µ–∑ —Ç–æ–∫–µ–Ω–∞, —Ç–æ–∫–µ–Ω –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ push)
  GITHUB_REPO: github.com/Felix-neko/architecture-future_2_0.git

# =============================================================================
# –°—Ç–∞–¥–∏—è: test ‚Äî Hello World –ø—Ä–∏–º–µ—Ä
# =============================================================================
hello_world:
  stage: test
  # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç–æ–π –æ–±—Ä–∞–∑ Alpine
  image: alpine:latest
  # –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –≤–µ—Ç–∫–∏ terraform
  only:
    - terraform
  script:
    - echo "üéâ Hello World from GitLab CI/CD!"
    - echo "Branch: $CI_COMMIT_BRANCH"
    - echo "Commit: $CI_COMMIT_SHA"
    - echo "Author: $CI_COMMIT_AUTHOR"
    - echo "Message: $CI_COMMIT_MESSAGE"
    - echo ""
    - echo "‚úì Pipeline –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!"

# =============================================================================
# –°—Ç–∞–¥–∏—è: test ‚Äî –ü—Ä–æ–≤–µ—Ä–∫–∞ Terraform-—Ñ–∞–π–ª–æ–≤
# =============================================================================
terraform_validate:
  stage: test
  # –û–±—Ä–∞–∑ —Å Terraform
  image: hashicorp/terraform:latest
  # –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –≤–µ—Ç–∫–∏ terraform
  only:
    - terraform
  script:
    - echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ Terraform-–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏..."
    - cd task_1_terraform_module/terraform/vm_module
    - terraform init -backend=false
    - terraform validate
    - echo "‚úì Terraform-–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤–∞–ª–∏–¥–Ω–∞!"
  # –†–∞–∑—Ä–µ—à–∞–µ–º –Ω–µ—É–¥–∞—á—É (–µ—Å–ª–∏ Terraform –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)
  allow_failure: true

# =============================================================================
# –°—Ç–∞–¥–∏—è: deploy ‚Äî Push –≤ GitHub
# =============================================================================
push_to_github:
  stage: deploy
  # –û–±—Ä–∞–∑ —Å Git
  image: alpine/git:latest
  # –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –≤–µ—Ç–∫–∏ terraform
  only:
    - terraform
  # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
  variables:
    # –û—Ç–∫–ª—é—á–∞–µ–º –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (—É –Ω–∞—Å —É–∂–µ –µ—Å—Ç—å –∫–æ–¥)
    GIT_STRATEGY: clone
  script:
    - echo "üöÄ Push –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ GitHub..."
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç–æ–∫–µ–Ω–∞
    - |
      if [ -z "$GITHUB_TOKEN" ]; then
        echo "‚ùå GITHUB_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!"
        echo "–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é GITHUB_TOKEN –≤ Settings -> CI/CD -> Variables"
        exit 1
      fi
    
    # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º Git
    - git config --global user.email "gitlab-ci@local"
    - git config --global user.name "GitLab CI"
    
    # –î–æ–±–∞–≤–ª—è–µ–º GitHub –∫–∞–∫ remote
    - git remote add github "https://x-access-token:${GITHUB_TOKEN}@${GITHUB_REPO}" || git remote set-url github "https://x-access-token:${GITHUB_TOKEN}@${GITHUB_REPO}"
    
    # Push –≤ GitHub
    - git push github HEAD:${GITHUB_BRANCH} --force
    
    - echo "‚úì –ò–∑–º–µ–Ω–µ–Ω–∏—è —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ GitHub!"
  # –ó–∞–≤–∏—Å–∏—Ç –æ—Ç —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤
  needs:
    - hello_world
